@using Gui.Events
@using Gui.Models
@using Gui.Query
@inject IEventService EventService
@inject IQueryService QueryService


@* @if (totalPages != 0) *@
@* { *@
<Pagination Class="my-pagination"
            ActivePageNumber="@currentPage"
            TotalPages="@totalPages"
            FirstLinkIcon="IconName.ChevronDoubleLeft"
            PreviousLinkIcon="IconName.ChevronLeft"
            NextLinkIcon="IconName.ChevronRight"
            Alignment="Alignment.Center"
            LastLinkIcon="IconName.ChevronDoubleRight"
            PageChanged="OnPageChangedAsync"/>
@* } *@


<div class="list-container">
    @foreach (var book in books)
    {
        <div class="book-card">
            <div class="book-cover">
                <img src="@book.ImageUrl" alt="@book.Title book cover"/>
                <div class="book-description">@book.Description</div>
            </div>
            <div class="book-info">
                <p class="book-title">@book.Title</p>
                <div class="book-author-rating">
                    <span>@book.Author</span>
                    <p class="book-rating">
                        @($"{book.Rating:F1}") <i class="fas fa-star"></i>
                    </p>
                </div>
                <div class="book-tags">
                    @foreach (var tag in book.Tags)
                    {
                        <div class="tag-chip">@tag</div>
                    }
                </div>
            </div>
        </div>
    }
</div>


@code {

    private int totalPages = 0;
    private int currentPage = 1;

    private string queryString = "";
    private string previouslyRead = "";

    private IEnumerable<BookCard> books = [];

    protected override void OnInitialized()
    {
        EventService.OnQuerySearch += HandleQuerySearch;
    }

    private async Task HandleQuerySearch((string query, string read, int pageNumber) query)
    {
        var result = await QueryService.QueryAsync(query.query, query.read, query.pageNumber);
        this.queryString = query.query;
        this.previouslyRead = query.read;
        this.currentPage = query.pageNumber;
        totalPages = result.Total / 2;

        Console.WriteLine($"Total pages: {totalPages}");
        
        if (result.Total % 2 != 0)
        {
            totalPages++;
        }
        
        Console.WriteLine($"Total pages: {totalPages}");


        books = result.Results;
        StateHasChanged();
    }

    private async Task OnPageChangedAsync(int pageNumber)
    {
        currentPage = pageNumber;
        var result = await QueryService.QueryAsync(queryString, previouslyRead, currentPage);
        totalPages = result.Total / 2;

        if (result.Total % 2 != 0)
        {
            totalPages++;
        }

        books = result.Results;
        StateHasChanged();
    }

}